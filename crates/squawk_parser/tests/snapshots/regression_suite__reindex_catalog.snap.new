---
source: crates/squawk_parser/tests/regression_suite.rs
assertion_line: 87
input_file: crates/squawk_parser/tests/data/regression_suite/reindex_catalog.sql
---
SOURCE_FILE
  COMMENT "--"
  WHITESPACE "\n"
  COMMENT "-- Check that system tables can be reindexed."
  WHITESPACE "\n"
  COMMENT "--"
  WHITESPACE "\n"
  COMMENT "-- Note that this test currently is not included in the default"
  WHITESPACE "\n"
  COMMENT "-- schedules, as currently reindexing catalog tables can cause"
  WHITESPACE "\n"
  COMMENT "-- deadlocks:"
  WHITESPACE "\n"
  COMMENT "--"
  WHITESPACE "\n"
  COMMENT "-- * The lock upgrade between the ShareLock acquired for the reindex"
  WHITESPACE "\n"
  COMMENT "--   and RowExclusiveLock needed for pg_class/pg_index locks can"
  WHITESPACE "\n"
  COMMENT "--   trigger deadlocks."
  WHITESPACE "\n"
  COMMENT "--"
  WHITESPACE "\n"
  COMMENT "-- * The uniqueness checks performed when reindexing a unique/primary"
  WHITESPACE "\n"
  COMMENT "--   key index possibly need to wait for the transaction of a"
  WHITESPACE "\n"
  COMMENT "--   about-to-deleted row in pg_class to commit. That can cause"
  WHITESPACE "\n"
  COMMENT "--   deadlocks because, in contrast to user tables, locks on catalog"
  WHITESPACE "\n"
  COMMENT "--   tables are routinely released before commit - therefore the lock"
  WHITESPACE "\n"
  COMMENT "--   held for reindexing doesn't guarantee that no running transaction"
  WHITESPACE "\n"
  COMMENT "--   performed modifications in the table underlying the index."
  WHITESPACE "\n"
  COMMENT "--"
  WHITESPACE "\n"
  COMMENT "--   This is particularly problematic as such conflicts can be"
  WHITESPACE "\n"
  COMMENT "--   triggered even when run in isolation, as a previous session's"
  WHITESPACE "\n"
  COMMENT "--   temporary table cleanup might still be running (even when the"
  WHITESPACE "\n"
  COMMENT "--   session ended from a client perspective)."
  WHITESPACE "\n\n\n"
  COMMENT "-- Check reindexing of whole tables"
  WHITESPACE "\n"
  REINDEX_STMT
    REINDEX_KW "REINDEX"
    WHITESPACE " "
    TABLE_KW "TABLE"
    WHITESPACE " "
    NAME
      IDENT "pg_class"
  SEMICOLON ";"
  WHITESPACE " "
  COMMENT "-- mapped, non-shared, critical"
  WHITESPACE "\n"
  REINDEX_STMT
    REINDEX_KW "REINDEX"
    WHITESPACE " "
    TABLE_KW "TABLE"
    WHITESPACE " "
    NAME
      IDENT "pg_index"
  SEMICOLON ";"
  WHITESPACE " "
  COMMENT "-- non-mapped, non-shared, critical"
  WHITESPACE "\n"
  REINDEX_STMT
    REINDEX_KW "REINDEX"
    WHITESPACE " "
    TABLE_KW "TABLE"
    WHITESPACE " "
    NAME
      IDENT "pg_operator"
  SEMICOLON ";"
  WHITESPACE " "
  COMMENT "-- non-mapped, non-shared, critical"
  WHITESPACE "\n"
  REINDEX_STMT
    REINDEX_KW "REINDEX"
    WHITESPACE " "
    TABLE_KW "TABLE"
    WHITESPACE " "
    NAME
      IDENT "pg_database"
  SEMICOLON ";"
  WHITESPACE " "
  COMMENT "-- mapped, shared, critical"
  WHITESPACE "\n"
  REINDEX_STMT
    REINDEX_KW "REINDEX"
    WHITESPACE " "
    TABLE_KW "TABLE"
    WHITESPACE " "
    NAME
      IDENT "pg_shdescription"
  SEMICOLON ";"
  WHITESPACE " "
  COMMENT "-- mapped, shared non-critical"
  WHITESPACE "\n\n"
  COMMENT "-- Check that individual system indexes can be reindexed. That's a bit"
  WHITESPACE "\n"
  COMMENT "-- different from the entire-table case because reindex_relation"
  WHITESPACE "\n"
  COMMENT "-- treats e.g. pg_class special."
  WHITESPACE "\n"
  REINDEX_STMT
    REINDEX_KW "REINDEX"
    WHITESPACE " "
    INDEX_KW "INDEX"
    WHITESPACE " "
    NAME
      IDENT "pg_class_oid_index"
  SEMICOLON ";"
  WHITESPACE " "
  COMMENT "-- mapped, non-shared, critical"
  WHITESPACE "\n"
  REINDEX_STMT
    REINDEX_KW "REINDEX"
    WHITESPACE " "
    INDEX_KW "INDEX"
    WHITESPACE " "
    NAME
      IDENT "pg_class_relname_nsp_index"
  SEMICOLON ";"
  WHITESPACE " "
  COMMENT "-- mapped, non-shared, non-critical"
  WHITESPACE "\n"
  REINDEX_STMT
    REINDEX_KW "REINDEX"
    WHITESPACE " "
    INDEX_KW "INDEX"
    WHITESPACE " "
    NAME
      IDENT "pg_index_indexrelid_index"
  SEMICOLON ";"
  WHITESPACE " "
  COMMENT "-- non-mapped, non-shared, critical"
  WHITESPACE "\n"
  REINDEX_STMT
    REINDEX_KW "REINDEX"
    WHITESPACE " "
    INDEX_KW "INDEX"
    WHITESPACE " "
    NAME
      IDENT "pg_index_indrelid_index"
  SEMICOLON ";"
  WHITESPACE " "
  COMMENT "-- non-mapped, non-shared, non-critical"
  WHITESPACE "\n"
  REINDEX_STMT
    REINDEX_KW "REINDEX"
    WHITESPACE " "
    INDEX_KW "INDEX"
    WHITESPACE " "
    NAME
      IDENT "pg_database_oid_index"
  SEMICOLON ";"
  WHITESPACE " "
  COMMENT "-- mapped, shared, critical"
  WHITESPACE "\n"
  REINDEX_STMT
    REINDEX_KW "REINDEX"
    WHITESPACE " "
    INDEX_KW "INDEX"
    WHITESPACE " "
    NAME
      IDENT "pg_shdescription_o_c_index"
  SEMICOLON ";"
  WHITESPACE " "
  COMMENT "-- mapped, shared, non-critical"
  WHITESPACE "\n\n"
  COMMENT "-- Check the same REINDEX INDEX statements under parallelism."
  WHITESPACE "\n"
  BEGIN_STMT
    BEGIN_KW "BEGIN"
  SEMICOLON ";"
  WHITESPACE "\n"
  SET_STMT
    SET_KW "SET"
    WHITESPACE " "
    NAME_REF
      IDENT "min_parallel_table_scan_size"
    WHITESPACE " "
    EQ "="
    WHITESPACE " "
    LITERAL
      INT_NUMBER "0"
  SEMICOLON ";"
  WHITESPACE "\n"
  REINDEX_STMT
    REINDEX_KW "REINDEX"
    WHITESPACE " "
    INDEX_KW "INDEX"
    WHITESPACE " "
    NAME
      IDENT "pg_class_oid_index"
  SEMICOLON ";"
  WHITESPACE " "
  COMMENT "-- mapped, non-shared, critical"
  WHITESPACE "\n"
  REINDEX_STMT
    REINDEX_KW "REINDEX"
    WHITESPACE " "
    INDEX_KW "INDEX"
    WHITESPACE " "
    NAME
      IDENT "pg_class_relname_nsp_index"
  SEMICOLON ";"
  WHITESPACE " "
  COMMENT "-- mapped, non-shared, non-critical"
  WHITESPACE "\n"
  REINDEX_STMT
    REINDEX_KW "REINDEX"
    WHITESPACE " "
    INDEX_KW "INDEX"
    WHITESPACE " "
    NAME
      IDENT "pg_index_indexrelid_index"
  SEMICOLON ";"
  WHITESPACE " "
  COMMENT "-- non-mapped, non-shared, critical"
  WHITESPACE "\n"
  REINDEX_STMT
    REINDEX_KW "REINDEX"
    WHITESPACE " "
    INDEX_KW "INDEX"
    WHITESPACE " "
    NAME
      IDENT "pg_index_indrelid_index"
  SEMICOLON ";"
  WHITESPACE " "
  COMMENT "-- non-mapped, non-shared, non-critical"
  WHITESPACE "\n"
  REINDEX_STMT
    REINDEX_KW "REINDEX"
    WHITESPACE " "
    INDEX_KW "INDEX"
    WHITESPACE " "
    NAME
      IDENT "pg_database_oid_index"
  SEMICOLON ";"
  WHITESPACE " "
  COMMENT "-- mapped, shared, critical"
  WHITESPACE "\n"
  REINDEX_STMT
    REINDEX_KW "REINDEX"
    WHITESPACE " "
    INDEX_KW "INDEX"
    WHITESPACE " "
    NAME
      IDENT "pg_shdescription_o_c_index"
  SEMICOLON ";"
  WHITESPACE " "
  COMMENT "-- mapped, shared, non-critical"
  WHITESPACE "\n"
  ROLLBACK_STMT
    ROLLBACK_KW "ROLLBACK"
  SEMICOLON ";"
  WHITESPACE "\n"
